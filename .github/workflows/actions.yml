# Ð˜Ð¼Ñ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð² GitHub Actions
name: CI Build and Test

# Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž: ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ push Ð² Ð²ÐµÑ‚ÐºÑƒ main
  push:
    branches: [ "main" ]
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ pull request Ð² Ð²ÐµÑ‚ÐºÑƒ main
  pull_request:
    branches: [ "main" ]
  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ ÑÐ¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Actions
  workflow_dispatch:
    inputs:
      # Ð’Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°: Ð²Ñ‹Ð±Ð¾Ñ€ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð½Ð°Ð±Ð¾Ñ€Ð°
      suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - allTests

jobs:
  # Ð•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ Ð² ÑÑ‚Ð¾Ð¼ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ
  build-and-test:
    # Ð˜Ð¼Ñ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒÑÑ Ð² GitHub
    name: Build, Test and Publish Report
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ubuntu Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ
    runs-on: ubuntu-latest

    steps:
      # Ð¨Ð°Ð³ 1: ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Maven Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ ÑÐ±Ð¾Ñ€Ð¾Ðº
          cache: maven

      # Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž: ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Maven Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # Ð¨Ð°Ð³ 3: Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Maven
      # Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐž: Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°ÑŽÑ‚ÑÑ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ, Ð° Ð½Ðµ Ñ‡ÐµÑ€ÐµÐ· env
      - name: Run tests
        env:
          login: ${{ secrets.SD_USER }}
          password: ${{ secrets.SD_PASSWORD }}
        run: mvn clean test -DsuiteName=${{ github.event.inputs.suite || 'smoke' }}

      # Ð¨Ð°Ð³ 4: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Allure
      # 'if: always()' Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾Ñ‚ ÑˆÐ°Ð³ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑÑ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ‚ÐµÑÑ‚Ñ‹ ÑƒÐ¿Ð°Ð´ÑƒÑ‚
      - name: Generate Allure Report
        if: always()
        run: mvn allure:report

      # Ð¨Ð°Ð³ 5: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸ Allure
      - name: Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results
          retention-days: 7

      # Ð¨Ð°Ð³ 6: Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Allure Ð½Ð° GitHub Pages Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°
      # Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐž: Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð· main Ð²ÐµÑ‚ÐºÐ¸
      - name: Deploy Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
          publish_dir: target/site/allure-maven-plugin
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹
          keep_files: true

      # Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž: Ð¨Ð°Ð³ 7 - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Allure Ð¾Ñ‚Ñ‡ÐµÑ‚
      - name: Display Allure Report URL
        if: always()
        run: |
          echo "=========================================="
          echo "ðŸ“Š ALLURE TEST REPORT"
          echo "=========================================="
          echo ""
          echo "ðŸŒ ÐžÑ‚Ñ‡ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ ÑÑÑ‹Ð»ÐºÐµ:"
          echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "ðŸ“ˆ Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²:"
          echo "   - Workflow: ${{ github.workflow }}"
          echo "   - Ð—Ð°Ð¿ÑƒÑÐº: ${{ github.run_id }}"
          echo "   - Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}"
          echo "   - ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}"
          echo ""
          echo "ðŸ”§ Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾ ÑÑÑ‹Ð»ÐºÐµ Ð²Ñ‹ÑˆÐµ."
          echo "=========================================="

      # Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž: Ð¨Ð°Ð³ 8 - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ summary Ñ ÑÑÑ‹Ð»ÐºÐ¾Ð¹ Ð½Ð° Ð¾Ñ‚Ñ‡ÐµÑ‚
      - name: Create Summary with Report Link
        if: always()
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "# ðŸ“Š Allure Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ¸" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸŒ Allure Ð¾Ñ‚Ñ‡ÐµÑ‚:** [$REPORT_URL]($REPORT_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **ðŸ”§ Workflow:** [$WORKFLOW_URL]($WORKFLOW_URL)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐµ" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð’ÐµÑ‚ÐºÐ°:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ÐÐ°Ð±Ð¾Ñ€ Ñ‚ÐµÑÑ‚Ð¾Ð²:** ${{ github.event.inputs.suite || 'smoke' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸*" >> $GITHUB_STEP_SUMMARY
