# –ò–º—è —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ GitHub Actions
name: CI Build and Test

# –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Pages
permissions:
  contents: write
  pages: write
  id-token: write

# –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ push –≤ –≤–µ—Ç–∫—É main
  push:
    branches: [ "main" ]
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ pull request –≤ –≤–µ—Ç–∫—É main
  pull_request:
    branches: [ "main" ]
  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–æ—Ç —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã Actions
  workflow_dispatch:
    inputs:
      # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞: –≤—ã–±–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞
      suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - allTests
      # –î–û–ë–ê–í–õ–ï–ù–û: –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      send_email:
        description: 'Send email report'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤ —ç—Ç–æ–º —Ä–∞–±–æ—á–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
  build-and-test:
    # –ò–º—è –∑–∞–¥–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ GitHub
    name: Build, Test and Publish Report
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Ubuntu –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4

      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Maven –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–æ–∫
          cache: maven

      # –î–û–ë–ê–í–õ–ï–ù–û: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # –®–∞–≥ 3: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Maven
      # –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–µ–∫—Ä–µ—Ç—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, –∞ –Ω–µ —á–µ—Ä–µ–∑ env
      - name: Run tests
        run: mvn clean test -DsuiteName=${{ github.event.inputs.suite || 'smoke' }} -Duser=${{ secrets.SD_USER }} -Dpassword=${{ secrets.SD_PASSWORD }}

      # –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ Allure
      # 'if: always()' –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —ç—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–¥—É—Ç
      - name: Generate Allure Report
        if: always()
        run: mvn allure:report

      # –®–∞–≥ 5: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ Allure
      - name: Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results
          retention-days: 7

      # –®–∞–≥ 6: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ Allure –Ω–∞ GitHub Pages –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      # –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ –¥–ª—è –¥–µ–ø–ª–æ—è —Ç–æ–ª—å–∫–æ –∏–∑ main –≤–µ—Ç–∫–∏
      - name: Deploy Allure report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
          publish_dir: target/site/allure-maven-plugin
          # –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç—á–µ—Ç—ã
          keep_files: true

      # –î–û–ë–ê–í–õ–ï–ù–û: –®–∞–≥ 7 - –û—Ç–ø—Ä–∞–≤–∫–∞ Allure –æ—Ç—á–µ—Ç–∞ –ø–æ email
      - name: Send Allure Report via Email
        if: always() && (github.event.inputs.send_email == 'true' || github.event_name == 'push')
        uses: dawidd6/action-send-mail@v3
        with:
          # –î–∞–Ω–Ω—ã–µ SMTP —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è mail.ru)
          server_address: smtp.mail.ru
          server_port: 465
          username: ${{ secrets.pavel.2006.91@mail.ru}}
          password: ${{ secrets.sUAIBT9dJodcNvjyBkXA}}
          # –î–∞–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞
          subject: 'Allure Test Report - ${{ github.repository }} - ${{ github.sha }}'
          to: Pavel.2006.91@mail.ru
          from: GitHub Actions
          # –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞
          body: |
            –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω!
            
            üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
            - –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            - –í–µ—Ç–∫–∞: ${{ github.ref }}
            - –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            - –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
            - –°—Å—ã–ª–∫–∞ –Ω–∞ workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ.
            
            ---
            –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç GitHub Actions.
          # –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º HTML –æ—Ç—á–µ—Ç
          attachments: target/site/allure-maven-plugin/index.html